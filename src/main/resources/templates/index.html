<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>MovieCatalog</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="/sockjs.js"></script>
    <script src="/stomp.js"></script>
    <script type="text/javascript">
        var stompClient = null;
        var allMovies = 'allMovies';
        var topMovies = 'topMovies';
        var latestMovies = 'latestMovies';

        window.onload = function() {
            console.log('window onload function');
            connect();
        }

        window.onclose = function () {
            disconnect();
        }

        function connect() {
            var socket = new SockJS('/movies');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/topRatedMovies', function(topRatedMoviesData) {
                    test(JSON.parse(topRatedMoviesData.body), topMovies);
                    console.log('topRatedData here');
                });
                stompClient.subscribe('/topic/latestMovies', function(latestMoviesData) {
                    test(JSON.parse(latestMoviesData.body), latestMovies);
                    console.log('latest movies here');
                });
                stompClient.subscribe('/topic/allMovies', function(allMoviesData) {
                    test(JSON.parse(allMoviesData.body), allMovies);
                    console.log('all movies here');
                    console.log(JSON.parse(allMoviesData.body));
                });
            });
        }
        function register() {
            stompClient.send("/rating/refresh", {}, {});
            stompClient.send("/movies/refresh", {}, {});
        }

        function disconnect() {
            if(stompClient != null) {
                stompClient.disconnect();
            }
            console.log("Disconnected");
        }

        function alert(data) {
            window.alert("Please refresh your browser" + data);
        }

        function showMovies(movies, tableId) {
            var moviesTable = document.getElementById(tableId);
            moviesTable.parentElement.removeChild(moviesTable);
            moviesTable.parentElement.appendChild(moviesTable);
        }

        function test(movies, tableId) {
            // / EXTRACT VALUE FOR HTML HEADER.
            // // ('Book ID', 'Book Name', 'Category' and 'Price')
            var col = [];
            for (var i = 0; i < movies.length; i++) {
                for (var key in movies[i]) {
                    if (col.indexOf(key) === -1) {
                        col.push(key);
                    }
                }
            }

            // CREATE DYNAMIC TABLE.
            var table = document.createElement("table");

            // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

            var tr = table.insertRow(-1);                   // TABLE ROW.

            for (var i = 0; i < col.length; i++) {
                var th = document.createElement("th");      // TABLE HEADER.
                th.innerHTML = col[i];
                tr.appendChild(th);
            }

            // ADD JSON DATA TO THE TABLE AS ROWS.
            for (var i = 0; i < movies.length; i++) {

                tr = table.insertRow(-1);

                for (var j = 0; j < col.length; j++) {
                    var tabCell = tr.insertCell(-1);
                    tabCell.innerHTML = movies[i][col[j]];
                }
            }

            // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
            var divContainer = document.getElementById(tableId);
            divContainer.parentElement.removeChild(divContainer);
            divContainer.parentElement.appendChild(divContainer);
            divContainer.innerHTML = "";
            divContainer.appendChild(table);
        }

    </script>
</head>
<body>

<div class="container">
    <h2>MovieCatalog</h2>
    <br>
    <h4>All movies</h4>
    <p id="allMovies"></p>
    <br>
    <h4>5 latest movies</h4>
    <p id="latestMovies"></p>
    <br>
    <h4>TOP 5 movies by rating</h4>
    <p id="topMovies"></p>
</div>

</body>
</html>